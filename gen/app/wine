#!/bin/sh
# Find and run wine, and set WINEPREFIX automatically.
set -e -o pipefail # POSIX:2022

if [ -z "$WINEPREFIX" ]; then
x=$PWD
while [ "$(readlink -f "$x")" != / ]; do
	if [ -f "$x/system.reg" -a -f "$x/user.reg" ]; then
		echo >&2 export WINEPREFIX=\"$(readlink -f "$x")\"
		export WINEPREFIX="$(readlink -f "$x")"
	fi
	x="$x/.."
done
fi
if [ -n "$WINE" ]; then
	exec "$WINE" "$@"
else
	for winehome in /opt/wine-local /opt/wine-staging /usr/local /usr; do
		if [ -f "$winehome/bin/$(basename "$0")" ]; then
			echo >&2 "using $winehome/bin/$(basename "$0")"
			exec "$winehome/bin/$(basename "$0")" "$@"
		fi
	done
	echo >&2 "could not find wine binary; try setting WINE"
	exit 1
fi
